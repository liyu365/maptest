<!doctype html>
<html lang="en">

<head>
    <title>百度地图测试</title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #container {
            height: 100%
        }

        .site_marker{
            background: yellow;
            box-shadow: 2px 2px 4px rgba(0,0,0,.2);
        }
    </style>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=dm65KD93tW9zmcZys9YvKIUj"></script>
</head>

<body>
<div id="container"></div>
</body>

<script>
    function SiteMarker(point, id) {
        this.point = point;
        this.width = 30;
        this.height = 30;
        this.id = id;
        this.startPosX = 0;
        this.startPosY = 0;
        this.lastPosX = 0;
        this.lastPosY = 0;
    }
    SiteMarker.prototype = new BMap.Overlay();

    //当调用map.addOverlay方法时，会调用此方法
    SiteMarker.prototype.initialize = function (map) {
        var _this = this;
        this.map = map;
        var wrap = document.createElement("div");
        wrap.style.position = "absolute";
        wrap.style.width = this.width + "px";
        wrap.style.height = this.height + "px";
        wrap.style.zIndex = BMap.Overlay.getZIndex(this.point.lat);
        wrap.innerHTML = this.id;
        wrap.className = 'site_marker';
        //将warp添加到覆盖物容器中
        map.getPanes().markerPane.appendChild(wrap);
        //保存warp实例
        this.wrap = wrap;

        wrap.addEventListener('click', function () {
            _this.showDetail();
        });
        wrap.addEventListener('touchstart', function (e) {
            _this.startPosX = e.touches ? e.touches[0].clientX : e.screenX;
            _this.startPosY = e.touches ? e.touches[0].clientY : e.screenY;
            _this.lastPosX = e.touches ? e.touches[0].clientX : e.screenX;
            _this.lastPosY = e.touches ? e.touches[0].clientY : e.screenY;
        });
        wrap.addEventListener('touchmove', function (e) {
            _this.lastPosX = e.touches ? e.touches[0].clientX : e.screenX;
            _this.lastPosY = e.touches ? e.touches[0].clientY : e.screenY;
        });
        wrap.addEventListener('touchend', function (e) {
            if (Math.abs(_this.lastPosX - _this.startPosX) < 5 && Math.abs(_this.lastPosY - _this.startPosY) < 5) {
                _this.showDetail();
            }
        });

        //一定要将添加到覆盖物容器的元素返回
        //当调用map.removeOverlay或者map.clearOverlays方法时，会将此处返回的元素删除
        return wrap;
    };

    SiteMarker.prototype.showDetail = function () {
        var _this = this;
        alert("当前标记点的id: " + _this.id);
    };

    //将覆盖物定位到正确的位置，每当地图状态发生变化都会重新调用
    SiteMarker.prototype.draw = function () {
        var position = this.map.pointToOverlayPixel(this.point);   //根据地理坐标转换为像素坐标，并设置给容器
        this.wrap.style.left = position.x - this.width / 2 + "px";
        this.wrap.style.top = position.y - this.width / 2 + "px";
    };

    //自定义覆盖物会自动继承Overlay的show和hide方法，方法会修改由initialize方法返回的DOM元素的style.display属性
    //如果自定义覆盖物元素较为复杂，可以自己实现show和hide方法
    SiteMarker.prototype.show = function () {
        if (this.wrap) {
            this.wrap.style.display = "";
        }
    };
    SiteMarker.prototype.hide = function () {
        if (this.wrap) {
            this.wrap.style.display = "none";
        }
    };
</script>

<script type="text/javascript">
    //初始化地图
    var map = new BMap.Map("container", {
        minZoom: 12,
        maxZoom: 15
    });
    map.addControl(new BMap.NavigationControl());
    map.centerAndZoom(new BMap.Point(117.210813, 39.14393), 13); //初始化地图，这里的坐标默认是天津中心坐标
    map.addEventListener("dragend", function () {
        var center = map.getCenter();
        console.log("地图中心点变更为：" + center.lng + ", " + center.lat);
    });
    map.addEventListener("zoomend", function () {
        console.log("地图缩放至：" + this.getZoom() + "级");
    });
    map.addEventListener("click", function (e) {
        console.log(e.point.lng + ", " + e.point.lat);
    });

    //向地图添加标记点
    var site_marker = new SiteMarker(new BMap.Point(117.211813, 39.15393), 1);
    var site_marker2 = new SiteMarker(new BMap.Point(117.209813, 39.13393), 2);
    map.addOverlay(site_marker);
    map.addOverlay(site_marker2);

    //开始定位用户自身位置
    var geolocation = new BMap.Geolocation();
    geolocation.getCurrentPosition(function (r) {
        if (this.getStatus() == BMAP_STATUS_SUCCESS) {
            var point = r.point;
            //map.centerAndZoom(point, 15);
            map.panTo(point);
            var self_marker = new BMap.Marker(point);
            map.addOverlay(self_marker);
        } else {
            switch (this.getStatus()) {
                case BMAP_STATUS_CITY_LIST:
                    console.log("城市列表");
                    break;
                case BMAP_STATUS_UNKNOWN_LOCATION:
                    console.log("位置结果未知");
                    break;
                case BMAP_STATUS_UNKNOWN_ROUTE:
                    console.log("导航结果未知");
                    break;
                case BMAP_STATUS_INVALID_KEY:
                    console.log("非法秘钥");
                    break;
                case BMAP_STATUS_INVALID_REQUEST:
                    console.log("非法请求");
                    break;
                case BMAP_STATUS_PERMISSION_DENIED:
                    console.log("没有权限");
                    break;
                case BMAP_STATUS_SERVICE_UNAVAILABLE:
                    console.log("服务不可用");
                    break;
                case BMAP_STATUS_TIMEOUT:
                    console.log("请求超时");
                    break;
            }
        }
    }, {enableHighAccuracy: true});
</script>

</html>